<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo de Prosperidad Sostenible (MPS)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para mejorar la visibilidad de la tabla */
        .table-container {
            overflow-x: auto; /* Permite desplazamiento horizontal en la tabla para móviles */
        }
        th, td {
            min-width: 100px; /* Ancho mínimo para cada celda de la tabla */
            padding: 10px;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10">
        
        <!-- Encabezado y Título Principal -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-2">
                Modelo de Prosperidad Sostenible (MPS)
            </h1>
            <p class="text-xl text-gray-600">
                Visualización de Indicadores y Resultados Clave
            </p>
        </header>

        <!-- Contenedor de Alerta de Carga/Error -->
        <div id="alertContainer" class="mb-6 p-4 rounded-lg text-sm hidden"></div>

        <!-- Panel de Métricas Clave -->
        <section class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Métricas Clave (Promedio Global)</h2>
            <div id="keyMetrics" class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <!-- Tarjeta de Métrica 1: Índice C_H -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                    <p class="text-sm font-semibold text-blue-600 uppercase">C_H (Capacidad Humana) Promedio</p>
                    <p id="avg_ch" class="text-3xl font-bold text-gray-900 mt-1">Cargando...</p>
                </div>
                <!-- Tarjeta de Métrica 2: PIB Nominal Total -->
                <div class="bg-green-50 p-6 rounded-lg shadow-md border-l-4 border-green-500">
                    <p class="text-sm font-semibold text-green-600 uppercase">PIB Nominal Total (MM USD)</p>
                    <p id="sum_pib" class="text-3xl font-bold text-gray-900 mt-1">Cargando...</p>
                </div>
                <!-- Tarjeta de Métrica 3: PS (Prosperidad Sostenible) Promedio -->
                <div class="bg-yellow-50 p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
                    <p class="text-sm font-semibold text-yellow-600 uppercase">PS (Prosperidad Sostenible) Promedio</p>
                    <p id="avg_ps" class="text-3xl font-bold text-gray-900 mt-1">Cargando...</p>
                </div>
            </div>
        </section>

        <!-- Sección de Datos Detallados -->
        <section>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Datos Detallados por Componente</h2>
            <div id="dataTable" class="table-container bg-white rounded-lg shadow-md">
                <p class="p-4 text-gray-500">Cargando tabla de datos...</p>
            </div>
        </section>

    </div>

    <!-- Librería PapaParse para analizar CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
        // Nombre del archivo CSV subido a GitHub Pages
        const DATA_FILE = 'datasetmps_corregido.csv'; 

        // Constantes de estilo de alerta
        const ALERT_ERROR_CLASSES = 'bg-red-100 border-red-400 text-red-700';
        const ALERT_WARNING_CLASSES = 'bg-yellow-100 border-yellow-400 text-yellow-700';
        const ALERT_SUCCESS_CLASSES = 'bg-green-100 border-green-400 text-green-700';
        const EXPECTED_FIELDS_COUNT = 28;

        /**
         * Muestra una alerta en la parte superior de la página.
         * @param {string} message - Mensaje a mostrar.
         * @param {string} type - Tipo de alerta ('error', 'warning', 'success').
         */
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            // La corrección es quitar las clases de estilo una por una
            alertContainer.classList.remove(...ALERT_ERROR_CLASSES.split(' '), ...ALERT_WARNING_CLASSES.split(' '), ...ALERT_SUCCESS_CLASSES.split(' '));
            
            let classes;
            switch (type) {
                case 'error':
                    classes = ALERT_ERROR_CLASSES;
                    break;
                case 'warning':
                    classes = ALERT_WARNING_CLASSES;
                    break;
                case 'success':
                default:
                    classes = ALERT_SUCCESS_CLASSES;
                    break;
            }

            alertContainer.className = `mb-6 p-4 rounded-lg text-sm ${classes}`;
            alertContainer.innerHTML = message;
            alertContainer.classList.remove('hidden');
        }

        /**
         * Limpia un valor numérico para permitir operaciones (maneja coma ',' como decimal).
         * @param {string} value - Valor de texto con posible separador decimal de coma.
         * @returns {number} Valor numérico.
         */
        function cleanNumber(value) {
            if (typeof value !== 'string') return 0;
            // Reemplaza el punto por nada (separador de miles) y la coma por punto (decimal)
            const cleaned = value.trim().replace(/\./g, '').replace(/,/g, '.');
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        /**
         * Renderiza la tabla de datos y calcula las métricas clave.
         * @param {Array<Object>} data - Datos CSV parseados.
         * @param {Array<string>} meta - Metadata del parseo.
         */
        function renderData(data, meta) {
            const dataTable = document.getElementById('dataTable');
            
            // 1. Filtrar filas defectuosas y sumar métricas
            let validData = [];
            let sum_ch = 0;
            let sum_pib = 0;
            let sum_ps = 0;
            
            // Nombres de columna (basados en datasetmps_corregido.csv)
            const psColumnName = 'PS (Sostenible)';
            const chColumnName = 'C_H (Índice)';
            const pibColumnName = 'PIB nominal (MM Dolar)';

            data.forEach(row => {
                const keys = Object.keys(row).filter(k => k !== ''); 
                
                // Validación estricta: si el número de campos no es el esperado, descartar la fila
                if (keys.length === EXPECTED_FIELDS_COUNT) {
                    validData.push(row);
                    
                    // Suma de métricas clave 
                    sum_ch += cleanNumber(row[chColumnName]);
                    sum_pib += cleanNumber(row[pibColumnName]);
                    sum_ps += cleanNumber(row[psColumnName]);
                }
            });

            // 2. Mostrar advertencia si se descartaron filas
            const discardedRows = data.length - validData.length;
            if (discardedRows > 0) {
                showAlert(`ADVERTENCIA: Se descartaron ${discardedRows} fila(s) debido a datos incompletos (esperado ${EXPECTED_FIELDS_COUNT} campos). Corrija el CSV o revise los campos vacíos al final de las líneas.`, 'warning');
            } else {
                showAlert(`Carga exitosa. Se analizaron ${data.length} filas con ${EXPECTED_FIELDS_COUNT} columnas cada una.`, 'success');
            }

            // 3. Renderizar Métricas Clave
            const count = validData.length;
            // Función para formatear el número de vuelta a formato regional (coma decimal, punto separador de miles)
            const formatNumber = (num) => num.toFixed(2).replace('.', 'TEMP').replace(/\B(?=(\d{3})+(?!\d))/g, '.').replace('TEMP', ',');

            document.getElementById('avg_ch').textContent = (count > 0 ? formatNumber(sum_ch / count) : 'N/A');
            document.getElementById('sum_pib').textContent = (sum_pib > 0 ? formatNumber(sum_pib) + 'M' : 'N/A');
            document.getElementById('avg_ps').textContent = (count > 0 ? formatNumber(sum_ps / count) : 'N/A');

            // 4. Renderizar Tabla
            if (validData.length === 0) {
                dataTable.innerHTML = '<p class="p-4 text-red-700">No se pudieron cargar datos válidos. El CSV puede estar mal formateado (delimitador o número de columnas). Revise que su CSV use punto y coma (;) como separador de campos.</p>';
                return;
            }

            const columns = Object.keys(validData[0]);
            
            let tableHTML = '<div class="table-container"><table class="min-w-full divide-y divide-gray-200">';
            
            // Encabezados
            tableHTML += '<thead class="bg-gray-100">';
            tableHTML += '<tr>' + columns.map(col => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`).join('') + '</tr>';
            tableHTML += '</thead>';

            // Filas de Datos
            tableHTML += '<tbody class="divide-y divide-gray-200">';
            validData.forEach(row => {
                tableHTML += '<tr class="hover:bg-gray-50">';
                tableHTML += columns.map(col => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row[col]}</td>`).join('');
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody>';
            
            tableHTML += '</table></div>';
            dataTable.innerHTML = tableHTML;
        }

        /**
         * Carga el archivo CSV usando PapaParse.
         */
        function loadData() {
            Papa.parse(DATA_FILE, {
                download: true,
                header: true,
                delimiter: ';', // FIJADO A PUNTO Y COMA
                dynamicTyping: false,
                skipEmptyLines: true,
                error: function(err, file) {
                    // Este error se dispara si el archivo no se encuentra (404) o hay un problema de red.
                    showAlert(`Error de Carga: No se pudo cargar el archivo: ${err.name}: ${err.message}. Asegúrese de que el archivo ${DATA_FILE} está en la carpeta raíz.`, 'error');
                },
                complete: function(results) {
                    if (results.errors.length > 0) {
                        const firstError = results.errors[0];
                        const errorMessage = `Error al analizar el CSV: ${firstError.message}.`;
                        // Se muestra el error específico de parsing
                        showAlert(`Error de Carga: ${errorMessage} El CSV tiene un problema de formato (delimitador o número de columnas).`, 'error');
                        document.getElementById('dataTable').innerHTML = `<p class="p-4 text-red-700">${errorMessage}</p>`;
                        return;
                    }
                    renderData(results.data, results.meta);
                }
            });
        }

        // Inicia la carga de datos al cargar la página
        window.onload = loadData;
    </script>
</body>
</html>
